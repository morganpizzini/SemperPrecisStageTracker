@page "/matches/{id}/stages/{stageId}/group/{groupId}"
@using Icon = Blazorise.Icons.FontAwesome.Icon
@inject HttpClientService Client
@inject IStringLocalizer<StageGroupDetail> L
@inject IJSRuntime JSRuntime

<Heading Size="HeadingSize.Is1">@L["Detail"]</Heading>
<Divider />
<Row>
    <Column ColumnSize="ColumnSize.Is6">
        <Card Margin="Margin.Is4.OnY">
            <CardBody>
                <CardTitle>@L["Group"]</CardTitle>
                <CardText>@group.Name</CardText>
                <CardTitle>@L["Shooters"]</CardTitle>
                <CardText>@group.Shooters.Count</CardText>
            </CardBody>
        </Card>
    </Column>
    @if (group.Match != null)
    {
        <Column ColumnSize="ColumnSize.Is6">
            <Card Margin="Margin.Is4.OnY">
                <CardBody>
                    <CardTitle>@L["Match"]</CardTitle>
                    <CardText>@group.Match.Name - @group.Match.MatchDateTime.ToString("d")</CardText>
                    <CardTitle>@L["Stage"]</CardTitle>
                    <CardText>@stage.Name</CardText>
                </CardBody>
            </Card>
        </Column>
    }
</Row>
<Divider />
<Row>
    <Column ColumnSize="ColumnSize.IsFull">
        <Card Margin="Margin.Is4.OnY">
            <CardBody>
                <CardTitle>@L["Shooters"]</CardTitle>
                @if (shooters.Count > 0)
                {
                    <Table Striped="true" Hoverable="true">
                        <TableHeader ThemeContrast="ThemeContrast.Dark">
                            <TableRow>
                                <TableHeaderCell>@L["Name"]</TableHeaderCell>
                                <TableHeaderCell>@L["Total"]</TableHeaderCell>
                                <TableHeaderCell></TableHeaderCell>
                            </TableRow>
                        </TableHeader>
                        <TableBody>
                            @foreach (var shooter in shooters)
                            {
                                var shooterTmp = shooter;
                                <TableRow>
                                    <TableRowHeader>@shooterTmp.Shooter.LastName @shooterTmp.Shooter.FirstName</TableRowHeader>
                                    <TableRowHeader>@(shooterTmp.ShooterStage.Total> 0 ? shooterTmp.ShooterStage.Total.ToString() : shooterTmp.ShooterStage.Total<0 ? @L["Disqualified"] : "")</TableRowHeader>
                                    <TableRowCell>
                                        <Button Color="Color.Primary" Clicked="@(() => FillShooter(shooterTmp))"><Icon Name="IconName.Pen" /></Button>
                                    </TableRowCell>
                                </TableRow>
                            }
                        </TableBody>
                    </Table>
                }
                else
                {
                    <Text>@L["NoShooters"]</Text>
                }
            </CardBody>
        </Card>
    </Column>
</Row>

<Modal @ref="modalRef" Size="@ModalSize.ExtraLarge">
    <ModalContent Centered="true">
        <ModalHeader>
            <ModalTitle>@L["FillShooter"]</ModalTitle>
            <CloseButton />
        </ModalHeader>
        <ModalBody>
            <Field>
                <FieldLabel>@L["Name"]</FieldLabel>
                <Text>@shooterToFill.LastName @shooterToFill.FirstName - @shooterToFill.BirthDate.ToString("g")</Text>
            </Field>
            <Validations @ref="validations" Mode="ValidationMode.Manual" Model="@model">

                <Tabs SelectedTab="@selectedTab" SelectedTabChanged="@OnSelectedTabChanged">
                    <Items>
                        <Tab Name="penalties">@L["Penalities"]</Tab>
                        <Tab Name="downs">@L["DownPoints"]</Tab>
                        <Tab Name="recap">@L["Recap"]</Tab>
                    </Items>
                    <Content>
                        <TabPanel Name="penalties">
                            <Validation Validator="@ValidationRule.None">
                                <Field Horizontal="true">
                                    <FieldLabel ColumnSize="ColumnSize.Is4">@L["Time"]</FieldLabel>
                                    <FieldBody ColumnSize="ColumnSize.Is8">
                                        <NumericEdit Placeholder="@L["Time"]" TValue="decimal" @bind-Value="@model.Time">
                                            <Feedback>
                                                <ValidationError>@L["WrongTime"]</ValidationError>
                                            </Feedback>
                                        </NumericEdit>
                                    </FieldBody>
                                </Field>
                            </Validation>
                            <Validation Validator="@ValidationRule.None">
                                <Field Horizontal="true">
                                    <FieldLabel ColumnSize="ColumnSize.Is4">@L["Procedurals"]</FieldLabel>
                                    <FieldBody ColumnSize="ColumnSize.Is8">
                                        <Addons>
                                            <Addon AddonType="AddonType.Body">
                                                <NumericEdit Placeholder="@L["Procedurals"]" TValue="int" @bind-Value="@model.Procedurals">
                                                    <Feedback>
                                                        <ValidationError>@L["WrongProcedurals"]</ValidationError>
                                                    </Feedback>
                                                </NumericEdit>
                                            </Addon>
                                            <Addon AddonType="AddonType.End">
                                                <Button Type="ButtonType.Button" Color="Color.Danger" disabled="@(model.Procedurals < 1 ? true : false)" Clicked="@(() => { model.Procedurals--; })"><Icon Name="IconName.MinusSquare" /></Button>
                                                <Button Type="ButtonType.Button" Color="Color.Success" Clicked="@(() => { model.Procedurals++; })"><Icon Name="IconName.PlusSquare" /></Button>
                                            </Addon>
                                        </Addons>
                                    </FieldBody>
                                </Field>
                            </Validation>
                            <Validation Validator="@ValidationRule.None">
                                <Field Horizontal="true">
                                    <FieldLabel ColumnSize="ColumnSize.Is4">@L["HitOnNonThreat"]</FieldLabel>
                                    <FieldBody ColumnSize="ColumnSize.Is8">
                                        <Addons>
                                            <Addon AddonType="AddonType.Body">
                                                <NumericEdit Placeholder="@L["HitOnNonThreat"]" TValue="int" @bind-Value="@model.HitOnNonThreat">
                                                    <Feedback>
                                                        <ValidationError>@L["WrongHitOnNonThreat"]</ValidationError>
                                                    </Feedback>
                                                </NumericEdit>
                                            </Addon>
                                            <Addon AddonType="AddonType.End">
                                                <Button Type="ButtonType.Button" Color="Color.Danger" disabled="@(model.HitOnNonThreat < 1 ? true : false)" Clicked="@(() => { model.HitOnNonThreat--; })"><Icon Name="IconName.MinusSquare" /></Button>
                                                <Button Type="ButtonType.Button" Color="Color.Success" Clicked="@(() => { model.HitOnNonThreat++; })"><Icon Name="IconName.PlusSquare" /></Button>
                                            </Addon>
                                        </Addons>
                                    </FieldBody>
                                </Field>
                            </Validation>
                            <Validation Validator="@ValidationRule.None">
                                <Field Horizontal="true">
                                    <FieldLabel ColumnSize="ColumnSize.Is4">@L["FlagrantPenalties"]</FieldLabel>
                                    <FieldBody ColumnSize="ColumnSize.Is8">
                                        <Addons>
                                            <Addon AddonType="AddonType.Body">
                                                <NumericEdit Placeholder="@L["FlagrantPenalties"]" TValue="int" @bind-Value="@model.FlagrantPenalties">
                                                    <Feedback>
                                                        <ValidationError>@L["WrongFlagrantPenalties"]</ValidationError>
                                                    </Feedback>
                                                </NumericEdit>
                                            </Addon>
                                            <Addon AddonType="AddonType.End">
                                                <Button Type="ButtonType.Button" Color="Color.Danger" disabled="@(model.FlagrantPenalties < 1 ? true : false)" Clicked="@(() => { model.FlagrantPenalties--; })"><Icon Name="IconName.MinusSquare" /></Button>
                                                <Button Type="ButtonType.Button" Color="Color.Success" Clicked="@(() => { model.FlagrantPenalties++; })"><Icon Name="IconName.PlusSquare" /></Button>
                                            </Addon>
                                        </Addons>
                                    </FieldBody>
                                </Field>
                            </Validation>
                            <Validation Validator="@ValidationRule.None">
                                <Field Horizontal="true">
                                    <FieldLabel ColumnSize="ColumnSize.Is4">@L["Ftdr"]</FieldLabel>
                                    <FieldBody ColumnSize="ColumnSize.Is8">
                                        <Addons>
                                            <Addon AddonType="AddonType.Body">
                                                <NumericEdit Placeholder="@L["Ftdr"]" TValue="int" @bind-Value="@model.Ftdr">
                                                    <Feedback>
                                                        <ValidationError>@L["WrongFtdr"]</ValidationError>
                                                    </Feedback>
                                                </NumericEdit>
                                            </Addon>
                                            <Addon AddonType="AddonType.End">
                                                <Button Type="ButtonType.Button" Color="Color.Danger" disabled="@(model.Ftdr < 1 ? true : false)" Clicked="@(() => { model.Ftdr--; })"><Icon Name="IconName.MinusSquare" /></Button>
                                                <Button Type="ButtonType.Button" Color="Color.Success" Clicked="@(() => { model.Ftdr++; })"><Icon Name="IconName.PlusSquare" /></Button>
                                            </Addon>
                                        </Addons>
                                    </FieldBody>
                                </Field>
                            </Validation>
                            <Row>
                                <Column ColumnSize="ColumnSize.IsHalf">
                                    <Validation Validator="@ValidationRule.None">
                                        <Field Horizontal="true">
                                            <FieldLabel ColumnSize="ColumnSize.Is4">&nbsp;</FieldLabel>
                                            <FieldBody ColumnSize="ColumnSize.Is8">
                                                <Check TValue="bool" @bind-Checked="@model.Procedural">@L["Procedural"]</Check>
                                            </FieldBody>
                                        </Field>
                                    </Validation>
                                </Column>
                                <Column ColumnSize="ColumnSize.IsHalf">
                                    <Validation Validator="@ValidationRule.None">
                                        <Field Horizontal="true">
                                            <FieldLabel ColumnSize="ColumnSize.Is4">&nbsp;</FieldLabel>
                                            <FieldBody ColumnSize="ColumnSize.Is8">
                                                <Check TValue="bool" @bind-Checked="@model.Disqualified">@L["Disqualified"]</Check>
                                            </FieldBody>
                                        </Field>
                                    </Validation>
                                </Column>
                            </Row>
                        </TabPanel>
                        <TabPanel Name="downs">
                            @for (int i = 0; i < model.DownPoints.Count; i++)
                            {
                                var tmp = i;
                                <Field Horizontal="true">
                                    <FieldLabel ColumnSize="ColumnSize.Is4">@L["Target"]&nbsp;@(tmp + 1)</FieldLabel>
                                    <FieldBody ColumnSize="ColumnSize.Is8">
                                        <Addons>
                                            <Addon AddonType="AddonType.Body">
                                                <input id="@($"target{tmp}")" type="number" value="@model.DownPoints[tmp]" class="form-control"
                                                       onfocus="this.select();"
                                                       @onkeydown="@((e) => Focus(e, tmp + 1))"
                                                       @onchange="@(e => model.DownPoints[tmp] = e.Value != null ? Convert.ToInt32(e.Value) : 0)" />

                                            </Addon>
                                            <Addon AddonType="AddonType.End">
                                                <Button Type="ButtonType.Button" Color="Color.Danger" disabled="@(model.DownPoints[tmp] < 1 ? true : false)" Clicked="@(() => { model.DownPoints[tmp]--; })"><Icon Name="IconName.MinusSquare" /></Button>
                                                <Button Type="ButtonType.Button" Color="Color.Success" Clicked="@(() => { model.DownPoints[tmp]++; })"><Icon Name="IconName.PlusSquare" /></Button>
                                            </Addon>
                                        </Addons>
                                    </FieldBody>
                                </Field>
                            }
                        </TabPanel>
                        <TabPanel Name="recap">
                            <Field Horizontal="true">
                                <FieldLabel ColumnSize="ColumnSize.Is4">@L["Time"]</FieldLabel>
                                <FieldBody ColumnSize="ColumnSize.Is8">
                                    <Text>@model.Time</Text>
                                </FieldBody>
                            </Field>
                            <Field Horizontal="true">
                                <FieldLabel ColumnSize="ColumnSize.Is4">@L["Procedurals"]</FieldLabel>
                                <FieldBody ColumnSize="ColumnSize.Is8">
                                    <Text>@model.Procedurals</Text>
                                </FieldBody>
                            </Field>
                            <Field Horizontal="true">
                                <FieldLabel ColumnSize="ColumnSize.Is4">@L["HitOnNonThreat"]</FieldLabel>
                                <FieldBody ColumnSize="ColumnSize.Is8">
                                    <Text>@model.HitOnNonThreat</Text>
                                </FieldBody>
                            </Field>
                            <Field Horizontal="true">
                                <FieldLabel ColumnSize="ColumnSize.Is4">@L["FlagrantPenalties"]</FieldLabel>
                                <FieldBody ColumnSize="ColumnSize.Is8">
                                    <Text>@model.FlagrantPenalties</Text>
                                </FieldBody>
                            </Field>
                            <Field Horizontal="true">
                                <FieldLabel ColumnSize="ColumnSize.Is4">@L["Ftdr"]</FieldLabel>
                                <FieldBody ColumnSize="ColumnSize.Is8">
                                    <Text>@model.Ftdr</Text>
                                </FieldBody>
                            </Field>
                            <Field Horizontal="true">
                                <FieldLabel ColumnSize="ColumnSize.Is4">@L["DownPoints"]</FieldLabel>
                                <FieldBody ColumnSize="ColumnSize.Is8">
                                    <Text>@model.DownPoints.Sum()</Text>
                                </FieldBody>
                            </Field>
                            <Divider />
                            <Field Horizontal="true">
                                <FieldLabel ColumnSize="ColumnSize.Is4">@L["Total"]</FieldLabel>
                                <FieldBody ColumnSize="ColumnSize.Is8">
                                    <Text>@(model.Total> 0 ? model.Total.ToString() : model.Total<0 ? @L["Disqualified"] : "" )</Text>
                                </FieldBody>
                            </Field>
                        </TabPanel>
                    </Content>
                </Tabs>

            </Validations>
        </ModalBody>
        <ModalFooter>
            <Button Color="Color.Secondary" Clicked="@(() => HideModal(false))">@L["Close"]</Button>
            <Button Color="Color.Primary" Clicked="@(() => HideModal(true))">@L["Submit"]</Button>
        </ModalFooter>
    </ModalContent>
</Modal>

@code {

    [Parameter]
    public string Id { get; set; }

    [Parameter]
    public string StageId { get; set; }

    [Parameter]
    public string GroupId { get; set; }

    string selectedTab = "penalties";

    private void OnSelectedTabChanged(string name)
    {
        selectedTab = name;
    }
    // reference to the modal component
    private Modal modalRef;
    ShooterContract shooterToFill = new ShooterContract();

    StageContract stage = new StageContract();

    GroupContract group = new GroupContract();
    IList<ShooterStageAggregationResult> shooters = new List<ShooterStageAggregationResult>();

    Validations validations;
    ShooterStageRequest model = new ShooterStageRequest();


    protected override async Task OnInitializedAsync()
    {
        await LoadShooters();
        stage = await Client.PostAsync<StageContract>("api/Stage/GetStage", new StageRequest() { StageId = StageId });
        model.StageId = stage.StageId;
        InitModelList();

        group = await Client.PostAsync<GroupContract>("api/Group/GetGroup", new GroupRequest() { GroupId = GroupId });

        await base.OnInitializedAsync();
    }

    async Task LoadShooters()
    {
        shooters = await Client.PostAsync<IList<ShooterStageAggregationResult>>("api/GroupShooter/FetchGroupShooterStage", new GroupStageRequest() { GroupId = GroupId, StageId = StageId});
    }
    void FillShooter(ShooterStageAggregationResult shooter)
    {
        if (shooter == null)
            return;

        shooterToFill = shooter.Shooter;
        model.ShooterId = shooterToFill.ShooterId;
        model.Disqualified = shooter.ShooterStage.Disqualified;
        model.DownPoints = shooter.ShooterStage.DownPoints;
        model.FlagrantPenalties = shooter.ShooterStage.FlagrantPenalties;
        model.Ftdr = shooter.ShooterStage.Ftdr;
        model.HitOnNonThreat = shooter.ShooterStage.HitOnNonThreat;
        model.Procedurals = shooter.ShooterStage.Procedurals;
        model.Time = shooter.ShooterStage.Time;
        InitModelList();
        selectedTab = "penalties";
        
        modalRef.Show();
    }

    void InitModelList()
    {
        if(model.DownPoints.Count > 0)
            return;
        var tmp = new List<int>();
        for (int i = 0; i < stage.Targets; i++)
        {
            tmp.Add(0);
        }
        model.DownPoints = tmp;
    }
    private async Task HideModal(bool choice)
    {
        if (choice)
        {
            if (!validations.ValidateAll())
                return;
            validations.ClearAll();
            var response = await Client.PostAsync<OkResponse>("/api/ShooterStage/UpsertShooterStage", model);
            await LoadShooters();
        }
        shooterToFill = new ShooterContract();
        InitModelList();
        modalRef.Hide();
    }
    public async Task Focus(KeyboardEventArgs e, int elementId)
    {
        if (await JSRuntime.InvokeAsync<bool>("customFunctions.isDevice"))
            return;
        if (e.Code == "Enter" || e.Code == "NumpadEnter")
        {
            if (elementId < 0 || elementId >= model.DownPoints.Count)
                return;
            await JSRuntime.InvokeVoidAsync("customFunctions.focusElement", $"target{elementId}");
        }
    }
}
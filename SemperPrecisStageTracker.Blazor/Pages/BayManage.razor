@page "/places/{id}/manage/bay/{bayId}/manage"
@inherits SemperPrecisBaseMainComponent
@inject IStringLocalizer<BayManage> L
@inject IState<UserState> UserState
@inject NavigationManager UriHelper

<Heading Size="HeadingSize.Is1">
    <Button Class="me-1" Color="Color.Primary" Size="Size.Small" Type="ButtonType.Link" To="@(RouteHelper.GetUrl<PlaceManage>(new{id = Id}))"><Icon Name="IconName.ArrowLeft" /></Button>
    @L["Manage"] @(model != null ? model.Name : "")
</Heading>
<Divider />
<AuthorizeView Roles="@(PermissionCtor.ManagePlaces.EditPlace.ToString())" Resource="@Id">
    <Authorizing>
        <h3 class="mt-5">@L["Loading"]</h3>
    </Authorizing>
    <NotAuthorized>
        <h3 class="mt-5">@L["NoAuth"]</h3>
    </NotAuthorized>
    <Authorized>
        @if (ApiLoading)
        {
            <p class="text-center">
                <Icon Name="FontAwesomeIcons.AnimationSpinner2x" />
            </p>
        }
        else
        {
            @if (model != null)
            {
                <Card Margin="Margin.Is2.OnY">
                    <CardBody>
                        <Row>
                            <Column ColumnSize="ColumnSize.IsHalf">
                                <CardTitle>@L["name"]</CardTitle>
                                <CardText>@model.Name</CardText>
                            </Column>
                            <Column ColumnSize="ColumnSize.IsHalf">
                                <CardTitle>@L["description"]</CardTitle>
                                <CardText>@model.Description</CardText>
                            </Column>
                        </Row>
                    </CardBody>
                </Card>
                <BaySchedulesComponent BaySchedules=@baySchedules Schedules=@schedules AddCallback="AddSchedule" DeleteCallback="DeleteSchedule"></BaySchedulesComponent>
                <BayReservationComponent BayReservations=@bayReservations BaySchedules=@baySchedules Users=@users AddCallback="AddReservation" DeleteCallback="DeleteReservation"></BayReservationComponent>
            }
        }
    </Authorized>
</AuthorizeView>


@code {
    [Parameter]
    public string Id { get; set; } = string.Empty;
    [Parameter]
    public string BayId { get; set; } = string.Empty;

    BayContract model = new();
    IList<ScheduleContract> schedules = new List<ScheduleContract>();
    IList<ScheduleContract> baySchedules = new List<ScheduleContract>();
    IList<ReservationContract> bayReservations = new List<ReservationContract>();
    IList<UserContract> users = new List<UserContract>();
    
    protected override async Task OnInitializedAsync()
    {
        if (!AuthService.CheckPermissions(PermissionCtor.ManagePlaces.EditPlace, Id))
        {
            await base.OnInitializedAsync();
            return;
        }

        var resultRequest = Call<BayContract>(Models.RequestType.Get, $"/api/v2/places/{Id}/Bays/{BayId}");

        var scheduleRequest = LoadSchedules();
        var bayScheduleRequest = LoadBaySchedules();
        var bayReservationRequest = LoadBayReservations();
        var userRequest = LoadUsers();

        await Task.WhenAll(resultRequest, scheduleRequest, bayScheduleRequest, bayReservationRequest, userRequest);

        schedules = scheduleRequest.Result.Data;
        baySchedules = bayScheduleRequest.Result.Data;
        bayReservations = bayReservationRequest.Result.Data;
        users = userRequest.Result.Data;

        if (resultRequest != null)
        {
            model = resultRequest.Result.Data;
        }

        await base.OnInitializedAsync();
    }

    Task<BaseResponse<List<ScheduleContract>>> LoadSchedules() => Call<List<ScheduleContract>>(Models.RequestType.Get, $"api/v2/Places/{Id}/Schedules");
    Task<BaseResponse<List<ScheduleContract>>> LoadBaySchedules() => Call<List<ScheduleContract>>(Models.RequestType.Get, $"/api/v2/Places/{Id}/Bays/{BayId}/Schedules");
    Task<BaseResponse<List<ReservationContract>>> LoadBayReservations() => Call<List<ReservationContract>>(Models.RequestType.Get, $"/api/v2/Places/{Id}/Bays/{BayId}/Reservations");
    Task<BaseResponse<List<UserContract>>> LoadUsers() => Call<List<UserContract>>(Models.RequestType.Get, $"/api/v2/Users/{UserState.Value.User?.UserId}/users-in-team");


    private async Task AddSchedule(string scheduleId)
    {
        await Call(Models.RequestType.Post, $"/api/v2/Places/{Id}/Bays/{BayId}/Schedules", null, new ScheduleBayCreateRequest
        {
                ScheduleId = scheduleId
        });
        baySchedules = (await LoadBaySchedules()).Data;
    }

    private async Task DeleteSchedule(string scheduleId)
    {
        await Call(Models.RequestType.Delete, $"/api/v2/Places/{Id}/Bays/{BayId}/Schedules/{scheduleId}", L["ScheduleDeleteSuccess"]);
        baySchedules = (await LoadBaySchedules()).Data;
    }

    private async Task AddReservation(ReservationCreateRequest reservation)
    {
        await MainServiceLayer.AddReservation(Id,BayId, reservation);
        bayReservations = (await LoadBayReservations()).Data;
    }

    private async Task DeleteReservation(string reservationId)
    {
        await MainServiceLayer.DeleteReservation(Id, BayId, reservationId, L["ReservationDeleteSuccess"]);
        bayReservations = (await LoadBayReservations()).Data;
    }
}

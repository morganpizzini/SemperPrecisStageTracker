@inject IStringLocalizer<BayReservationComponent> L
@using Microsoft.AspNetCore.Components

<Card Margin="Margin.Is4.OnY">
    <CardBody> 
        <Row Class="mb-1">
            <Column ColumnSize="ColumnSize.Is8">
                <CardTitle>
                    @L["Reservations"]
                </CardTitle>
            </Column>
            <Column Class="text-end">
                <Button Size="Size.Small" Color="Color.Primary" Clicked="@(() => modalRefAddSchedule.Show())"><Icon Name="IconName.PlusSquare" /> @L["NewReservation"]</Button>
            </Column>
        </Row>
        <Table Striped="true" Hoverable="true">
            <TableHeader ThemeContrast="ThemeContrast.Dark">
                <TableRow>
                    <TableHeaderCell>@L["Name"]</TableHeaderCell>
                    <TableHeaderCell>@L["Day"]</TableHeaderCell>
                    <TableHeaderCell></TableHeaderCell>
                </TableRow>
            </TableHeader>
            <TableBody>
                <Virtualize Items="@BayReservations" Context="entity">
                    <TableRow>
                        <TableRowHeader>@entity.User.CompleteName</TableRowHeader>
                        <TableRowHeader>@entity.Day.ToString() - @entity.From.ToString("HH:mm") ~ @entity.To.ToString("HH:mm")</TableRowHeader>
                        <TableRowCell>
                            <Button Size="Size.Small" Color="Color.Danger" Clicked="@(() => DeleteScheduleEntity(entity))"><Icon Name="IconName.Delete" /></Button>
                        </TableRowCell>
                    </TableRow>
                </Virtualize>
            </TableBody>
        </Table>
    </CardBody>
</Card>
<Modal @ref="modalRefAddSchedule">
    <ModalContent Centered="true">
        <ModalHeader>
            <ModalTitle>@L["AddReservation"]</ModalTitle>
            <CloseButton />
        </ModalHeader>
        <ModalBody>
            <Field>
                <FieldLabel>@L["Users"]</FieldLabel>
                <select class="form-control" @bind="model.UserId">
                    <option disabled value="">@L["SelectUser"]</option>
                    @foreach (var user in Users)
                    {
                        <option value="@user.UserId">@user.CompleteName</option>
                    })
                </select>
            </Field>
            <Field>
                <FieldLabel >@L["Date"]</FieldLabel>
                <FieldBody>
                    <input name="from" class="form-control" type="date" value="@model.Day.ToString("yyyy-MM-dd")"
                           @onchange="@((ChangeEventArgs __e) => 
                                    {
                                        Console.WriteLine(__e?.Value?.ToString());
                                        var day = DateOnly.FromDateTime(DateTime.Parse(__e?.Value?.ToString()));
                                        if(model.Day != day){
                                            model.Day = day;
                                            addScheduleId = string.Empty;
                                        }
                                        
                                    })" />
                </FieldBody>
            </Field>
            <Field>
                <FieldLabel>@L["Schedule"]</FieldLabel>
                <select class="form-control" @bind="addScheduleId">
                    <option disabled value="">@L["SelectSchedule"]</option>
                    @foreach (var schedule in BaySchedules.Where(x=>x.Day == model.Day.DayOfWeek))
                    {
                        <option value="@schedule.ScheduleId">@schedule.Name [@schedule.Day.ToString() @schedule.From.ToString("HH:mm") ~ @schedule.To.ToString("HH:mm")]</option>
                    })
                </select>
            </Field>
        </ModalBody>
        <ModalFooter>
            <Button Size="Size.Small" Color="Color.Secondary" Clicked="@(() => HideModalModalRefAddReservation(false))">@L["Close"]</Button>
            <Button Size="Size.Small" Color="Color.Primary" Clicked="@(() => HideModalModalRefAddReservation(true))">@L["Save"]</Button>
        </ModalFooter>
    </ModalContent>
</Modal>
<Modal @ref="modalRefEntityReservationToDelete">
    <ModalContent Centered="true">
        <ModalHeader>
            <ModalTitle>@L["DeleteReservation"]</ModalTitle>
            <CloseButton />
        </ModalHeader>
        <ModalBody>
            <Field>
                <FieldLabel>@L["ConfirmDelete"]</FieldLabel>
            </Field>
            @if (entityReservationToDelete != null)
            {
                <Field>
                    <FieldLabel>@L["Name"]</FieldLabel>
                    <Text>@entityReservationToDelete.User.CompleteName</Text>
                </Field>
                <Field>
                    <FieldLabel>@L["Day"]</FieldLabel>
                    <Text>@entityReservationToDelete.Day</Text>
                </Field>
                <Field>
                    <FieldLabel>@L["From/To"]</FieldLabel>
                    <Text>@entityReservationToDelete.From.ToString("HH:mm") ~ @entityReservationToDelete.To.ToString("HH:mm")</Text>
                </Field>
            }
        </ModalBody>
        <ModalFooter>
            <Button Size="Size.Small" Color="Color.Secondary" Clicked="@(() => HideModalEntityReservationToDelete(false))">@L["Close"]</Button>
            <Button Size="Size.Small" Color="Color.Primary" Clicked="@(() => HideModalEntityReservationToDelete(true))">@L["Yes"]</Button>
        </ModalFooter>
    </ModalContent>
</Modal>
@code{
    private Modal modalRefEntityReservationToDelete = default!;
    private Modal modalRefAddSchedule = default!;
    ReservationContract entityReservationToDelete = new();

    ReservationCreateRequest model = new();
    string addScheduleId = string.Empty;
    // string addUserId = string.Empty;
    // DateOnly addDate = DateOnly.FromDateTime(DateTime.Now.Date);

    [Parameter, EditorRequired]
    public IList<ReservationContract> BayReservations { get; set; } = new List<ReservationContract>();
    [Parameter, EditorRequired]
    public IList<ScheduleContract> BaySchedules { get; set; } = new List<ScheduleContract>();
    [Parameter, EditorRequired]
    public IList<UserContract> Users { get; set; } = new List<UserContract>();

    [Parameter, EditorRequired]
    public EventCallback<ReservationCreateRequest> AddCallback { get; set; }
    [Parameter, EditorRequired]
    public EventCallback<string> DeleteCallback { get; set; }

    void DeleteScheduleEntity(ReservationContract entity)
    {
        if (entity == null)
            return;
        entityReservationToDelete = entity;
        modalRefEntityReservationToDelete.Show();
    }

    private async Task HideModalEntityReservationToDelete(bool choice)
    {
        if (choice && entityReservationToDelete != null)
        {
            await DeleteCallback.InvokeAsync(entityReservationToDelete.ReservationId);
            entityReservationToDelete = new();
        }
        await modalRefEntityReservationToDelete.Hide();
    }

    private async Task HideModalModalRefAddReservation(bool choice)
    {
        if (choice && !string.IsNullOrEmpty(addScheduleId)
        && !string.IsNullOrEmpty(model.UserId))
        {
            var schedule = BaySchedules.FirstOrDefault(x => x.ScheduleId == addScheduleId);
            if(schedule != null)
            {
                model.From = schedule.From;
                model.To = schedule.To;
                await AddCallback.InvokeAsync(model);
            }
        }
        addScheduleId = string.Empty;
        model = new();
        await modalRefAddSchedule.Hide();
    }
}